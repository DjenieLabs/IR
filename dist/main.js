"use strict";define(["HubLink","Easy","PropertiesPanel","RIB"],function(t,e,i,o){function n(){var t=[],e=!0,i=!1,o=void 0;try{for(var n,s=this.codeList[Symbol.iterator]();!(e=(n=s.next()).done);e=!0){var r=n.value;r.message&&void 0!==r.message&&t.push(r.name.toLowerCase())}}catch(t){i=!0,o=t}finally{try{!e&&s.return&&s.return()}finally{if(i)throw o}}return t}function s(t,e){var i=-1;return t.some(function(t,o){if(t.index==e)return i=o,!0}),i}function r(t){l.call(this);var e=this;e.codeList.splice(s(e.codeList,$(t).attr("data-index")),1),g.call(this)}function a(t){t.removeClass("green").removeClass("yellow").addClass("red").transition("set looping").transition("flash","1000ms")}function c(t){var e=s(this.codeList,$(t).attr("data-index")),i=this.codeList[e].DOM.find("i.record"),o=this,n=void 0!==this.codeList[e].message;this.codeList[e].recording?(this.codeList[e].recording=!1,S(i,n)):(this.codeList.forEach(function(t,e){o.codeList[e].recording=!1,S(o.codeList[e].DOM.find("i.record"),void 0!==o.codeList[e].message)}),this.codeList[e].recording=!0,delete this.codeList[e].message,a(i),i.popup({content:"Waiting an IR signal...",position:"left center"}),i.popup("show"))}function l(){var t=this;this.myPropertiesWindow.find(".record-row").each(function(e){var i=s(t.codeList,$(this).attr("data-index"));t.codeList[i].name=$(this).find("input").val()})}function d(){l.call(this),this.codeList.push({name:"IR-"+(this.codeList.length+1),index:this.codeList.length}),g.call(this)}function h(){u.call(this,!0),console.log("Sending: ",this.controller._lastEvent),console.log("TO BE IMPLEMENTED!")}function u(t){var e=this.modalWindow.find(".checkbox").hasClass("checked");this.controller._rememberNext=e,this.controller._canSend=!0===t}function f(){if(this.modalWindow&&this.controller._lastEvent){if(this.controller._rememberNext)return void(this.controller._canSend&&h.call(this));this.modalWindow.modal({inverted:!0,transition:"scale",onApprove:h.bind(this),onDeny:u.bind(this)}).modal("show")}}function g(){var t=this;e.clearCustomSettingsPanel(),this.myPropertiesWindow=$(this.propTemplate({codes:this.codeList,basePath:this.basePath})),this.modalWindow=$(this.myPropertiesWindow[0]),this.myPropertiesWindow.find("#btAdd").click(d.bind(this)),this.myPropertiesWindow.find("#btDelete").click(function(){r.call(t,this)}),this.myPropertiesWindow.find("#btRecord").click(function(){c.call(t,this)}),this.myPropertiesWindow.find("#senddata-btn").click(function(){var e={to:"alex.agudelo@kitsunei.com",text:"["+t.lastRawData.toString()+"]",subject:"IR: Protocol not implemented"};$.ajax({type:"POST",crossDomain:!0,url:"http://replicatorcloud.na-inter.net/emailsender/send/",xhrFields:{withCredentials:!1},data:e,success:function(t){console.log("email sent to: ",e)},error:function(t,e,i){console.log("error sending email: ",i)}})}),e.displayCustomSettings(this.myPropertiesWindow),this.modalWindow.modal("hide"),this.myPropertiesWindow.find(".record-row").each(function(e){var i=s(t.codeList,$(this).attr("data-index"));t.codeList[i].DOM=$(this);var o=void 0!==t.codeList[i].message;S(t.codeList[i].DOM.find("i.record"),o),t.codeList[i].recording&&a(t.codeList[i].DOM.find("i.record"))})}function m(t){var e=this;return this.codeList.some(function(i,o){if(i.recording){i.recording=!1;var n=i.DOM.find("i.record");return S(n,!0),i.message=t,e.lastRawData=t.raw,n.popup("destroy"),"RAW"===t.type&&(e.controller._lastEvent=t,console.warn("This protocol is not yet implemented: ",t.raw),f.call(e)),!0}})}function v(t){Object.keys(t).length&&this.processData(t);var e=!0,i=!1,o=void 0;try{for(var n,s=this.getInputs()[Symbol.iterator]();!(e=(n=s.next()).done);e=!0){var r=n.value;t.hasOwnProperty(r.toLowerCase())||(t[r.toLowerCase()]=!1)}}catch(t){i=!0,o=t}finally{try{!e&&s.return&&s.return()}finally{if(i)throw o}}this.dispatchDataFeed(t)}function p(t){console.log(JSON.stringify(t));var e={},i=!0,o=!1,n=void 0;try{for(var s,r=this.codeList[Symbol.iterator]();!(i=(s=r.next()).done);i=!0){var a=s.value;if(t.raw&&t.raw.length>2&&a.message){var c={},l={};Object.assign(c,a.message),Object.assign(l,t),delete c.raw,delete l.raw,JSON.stringify(c)===JSON.stringify(l)&&(e[a.name.toLowerCase()]=!0,e.any=!0)}}}catch(t){o=!0,n=t}finally{try{!i&&r.return&&r.return()}finally{if(o)throw n}}v.call(this,e)}var y=["ANY"],w=["SET_FREQ"],L={};L.getActions=function(){return w.concat(n.call(this))},L.getDefaultAction=function(){var t=n.call(this);return t.length>0&&t[0]},L.getInputs=function(){var t=n.call(this);return y.concat(t)},L.getDefaultInput=function(){var t=n.call(this);return t.length>0&&t[0]},L.onBeforeSave=function(){return{codeList:this.codeList,defaultFreq:this.defaultFreq}},L.onLoad=function(){var t=this;this.addSubscription("block:change",function(e){e.type&&(m.call(t,e),p.call(t,e))}),this.loadTemplate("properties.html").then(function(e){t.propTemplate=e}),this.storedSettings&&this.storedSettings.codeList?(this.codeList=this.storedSettings.codeList,this.defaultFreq=this.storedSettings.defaultFreq||38):(this.codeList=[],this.defaultFreq=38),this.lastRawData=""},L.hasMissingProperties=function(){return!1},L.onCancelProperties=function(){console.log("Cancelling Properties")},L.onSaveProperties=function(t){l.call(this),console.log("Saving settings: ",t),t.Custom=this._tmpCustomObj,this.settings=t,this.saveSettings().catch(function(t){t.errorCode?alert("Error (make me a nice alert please): ",t.message):console.log(t)}),e.showDataFeed(this),L.hasMissingProperties.call(this)?this.displayState("warning","Add some IR code..."):this.clearState()},L.onClick=function(){var t=this;i.loading("Loading settings..."),this.loadSettings(function(i){console.log("Settings: ",i),i.EventMode={property:"EventMode",items:[{name:"Always",value:0,selected:0===i.EventMode},{name:"Never",value:1,selected:1===i.EventMode}]},t._tmpCustomObj=$.extend(!0,{},i.Custom),i.Custom={},e.showBaseSettings(t,i),g.call(t),e.openCustomSettingsAccordion()})},L.onExecute=function(t){if(console.log("Execute: ",t),"SET_FREQ"===t.action)return this.defaultFreq=Number(t.data),void console.log("Frequency set to %d Khz",this.defaultFreq);var e=this,i=!0,o=!1,n=void 0;try{for(var s,r=this.codeList[Symbol.iterator]();!(i=(s=r.next()).done);i=!0){var a=s.value;if(a.name.toLowerCase()==t.action){console.log("Sending item: ",a.message),this.APICall("transmitData",[a.message.raw,e.defaultFreq]).then(function(t){console.log("Transmission OK?: ",t)}).catch(function(t){console.error("Error transmitting: ",t)});break}}}catch(t){o=!0,n=t}finally{try{!i&&r.return&&r.return()}finally{if(o)throw n}}},L.onNewData=function(t){console.log("New data: ",t)};var S=function(t,e){t.removeClass("red").transition("remove looping"),e?t.addClass("green"):t.addClass("yellow")};return L});